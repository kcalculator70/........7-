<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure User App</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        input { padding: 10px; margin: 5px; width: 80%; border-radius: 5px; border: none; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; background: #00ffcc; border: none; font-weight: bold; border-radius: 5px; }
        button:hover { background: #00ccaa; }
        
        /* ‡¶™‡ßá‡¶ú ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã/‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        #cameraSection { display: none; } 
        #authSection { margin-top: 50px; }
        
        video { width: 90%; border: 3px solid #00ffcc; border-radius: 10px; transform: scaleX(-1); margin-top: 20px; }
        .status { color: yellow; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="authSection">
        <h2>üîê Login / Register</h2>
        <input type="email" id="email" placeholder="Enter Email"><br>
        <input type="password" id="password" placeholder="Enter Password"><br>
        <button onclick="registerUser()">Create Account</button>
        <button onclick="loginUser()">Login</button>
        <p id="authMsg" style="color: red;"></p>
    </div>

    <div id="cameraSection">
        <h3>ID: <span id="userIdDisplay" style="color: #00ffcc;">...</span></h3>
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="status" id="statusText">System Active. Waiting for Admin...</div>
        <button onclick="logout()" style="background: red; color: white;">Logout</button>
    </div>

    <script>
        // ‡¶§‡ßã‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        const firebaseConfig = {
          apiKey: "AIzaSyBy5AGDGQFZqbL83fKQfLViX_pyOu6AJ38",
          authDomain: "phone-f605e.firebaseapp.com",
          databaseURL: "https://phone-f605e-default-rtdb.firebaseio.com",
          projectId: "phone-f605e",
          storageBucket: "phone-f605e.firebasestorage.app",
          messagingSenderId: "902490805880",
          appId: "1:902490805880:web:98a5ed1432a0e3538e3f8d",
          measurementId: "G-WSJDCYKM3F"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.database();

        // --- ‡¶Ö‡¶•‡ßá‡¶®‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---

        // ‡ßß. ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
        function registerUser() {
            const email = document.getElementById("email").value;
            const pass = document.getElementById("password").value;
            
            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    alert("Account Created! Camera Starting...");
                })
                .catch((error) => {
                    document.getElementById("authMsg").innerText = error.message;
                });
        }

        // ‡ß®. ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ
        function loginUser() {
            const email = document.getElementById("email").value;
            const pass = document.getElementById("password").value;

            auth.signInWithEmailAndPassword(email, pass)
                .catch((error) => {
                    document.getElementById("authMsg").innerText = error.message;
                });
        }

        // ‡ß©. ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ
        function logout() {
            auth.signOut().then(() => location.reload());
        }

        // ‡ß™. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ (‡¶Æ‡ßá‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï)
        auth.onAuthStateChanged((user) => {
            if (user) {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶ì, ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
                document.getElementById("authSection").style.display = "none";
                document.getElementById("cameraSection").style.display = "block";
                document.getElementById("userIdDisplay").innerText = user.email;
                
                // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞
                startCameraSystem(user.uid, user.email);
            } else {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
                document.getElementById("authSection").style.display = "block";
                document.getElementById("cameraSection").style.display = "none";
            }
        });

        // --- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶≤‡¶ú‡¶ø‡¶ï ---
        
        function startCameraSystem(uid, email) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true })
            .then(stream => {
                document.getElementById("localVideo").srcObject = stream;
                
                // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶Ü‡¶Æ‡¶ø ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶õ‡¶ø
                db.ref("users/" + uid).set({
                    email: email,
                    status: "online",
                    lastSeen: Date.now()
                });

                // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶≤‡ßá ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                db.ref("users/" + uid).onDisconnect().update({
                    status: "offline"
                });

                // ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶∞‡¶ø‡¶∏‡¶ø‡¶≠ ‡¶ï‡¶∞‡¶æ
                db.ref("users/" + uid + "/offer").on("value", snapshot => {
                    const offer = snapshot.val();
                    if (offer) {
                        document.getElementById("statusText").innerText = "‚ö†Ô∏è Admin Connected!";
                        
                        const peer = new SimplePeer({ initiator: false, trickle: false, stream: stream });
                        peer.signal(offer);

                        peer.on('signal', answer => {
                            db.ref("users/" + uid + "/answer").set(answer);
                        });
                    }
                });
            })
            .catch(err => alert("Camera Error: " + err));
        }

    </script>
</body>
</html>